; Wait until the planner queue is empty
%wait

; Set user-defined variables
%CLEARANCE_HEIGHT = 100
%TOOL_CHANGE_X = -300
%TOOL_CHANGE_Y = -300
%TOOL_CHANGE_Z = CLEARANCE_HEIGHT
%TOOL_PROBE_X = 0
%TOOL_PROBE_Y = 0
%TOOL_PROBE_Z = 20
%PROBE_DISTANCE = 15
%PROBE_FEEDRATE = 20
%TOUCH_PLATE_HEIGHT = 10
%RETRACTION_DISTANCE = 10

; Keep a backup of current work position
%X0=posx, Y0=posy, Z0=posz

; Save modal state
; * Work Coordinate System: G54, G55, G56, G57, G58, G59
; * Plane: G17, G18, G19
; * Units: G20, G21
; * Distance Mode: G90, G91
; * Feed Rate Mode: G93, G94
; * Spindle State: M3, M4, M5
; * Coolant State: M7, M8, M9
%WCS = modal.wcs
%PLANE = modal.plane
%UNITS = modal.units
%DISTANCE = modal.distance
%FEEDRATE = modal.feedrate
%SPINDLE = modal.spindle
%COOLANT = modal.coolant

; Stop spindle
M5
; Absolute positioning
G90

; Raise to tool change Z
G0 Z[TOOL_CHANGE_Z]
; Go to tool change X,Y
G0 X[TOOL_CHANGE_X] Y[TOOL_CHANGE_Y]
; Wait until the planner queue is empty
%wait

; Pause the program for a manual tool change
M0

; Go to tool probe X,Y
G0 X[TOOL_PROBE_X] Y[TOOL_PROBE_Y]
; Lower to tool probe Z
G0 Z[TOOL_PROBE_Z]
; Wait until the planner queue is empty
%wait

; Pause the program before probing
M1

; Probe toward workpiece with a maximum probe distance
G91 ; Relative positioning
G38.2 Z-[PROBE_DISTANCE] F[PROBE_FEEDRATE]
G90 ; Absolute positioning

; Set Z0 for the active work coordinate system
G10 L20 P0 Z[TOUCH_PLATE_HEIGHT]

; Retract from the touch plate
G91 ; Relative positioning
G0 Z[RETRACTION_DISTANCE]
G90 ; Absolute positioning

; Raise to tool change Z
G53 Z[TOOL_CHANGE_Z]
; Go to tool change X,Y
G53 X[TOOL_CHANGE_X] Y[TOOL_CHANGE_Y]
; Wait until the planner queue is empty
%wait

; Pause the program for cleanup (e.g. remove touch plate, wires, etc)
M0

; Go to previous work position
G0 X[X0] Y[Y0]
G0 Z[Z0]

; Restore modal state
[WCS] [PLANE] [UNITS] [DISTANCE] [FEEDRATE] [SPINDLE] [COOLANT]
